INSERT overwrite TABLE fc_iwit_end_to_end_l2_hive_fact
select
ob.consignment_id,
ob.consignment_company,
outbound_request_id,
outbound_request_warehouse_id as source_warehouse_id,
source_warehouse_dim_key,
outbound_request_destination_party_id as destination_warehouse_id,
destination_warehouse_dim_key,
outbound_request_external_id,
outbound_request_status,
outbound_request_created_timestamp,
outbound_request_created_date_key,
outbound_request_created_time_key,
outbound_request_updated_timestamp,
outbound_request_updated_date_key,
outbound_request_updated_time_key,
min_picklist_created_timestamp,
min_picklist_created_date_key,
min_picklist_created_time_key,
max_picklist_created_timestamp,
max_picklist_created_date_key,
max_picklist_created_time_key,
consignment_created_timestamp,
consignment_created_date_key,
consignment_created_time_key,
consignment_status,
consignment_updated_timestamp,
consignment_updated_date_key,
consignment_updated_time_key,
consignment_cancelled_timestamp,
consignment_cancelled_date_key,
consignment_cancelled_time_key,
consignment_dispatched_timestamp,
consignment_dispatched_date_key,
consignment_dispatched_time_key,
consignment_packed_timestamp,
consignment_packed_date_key,
consignment_packed_time_key,
consignment_packed_by,
case when consignment_quantity is null then outbound_created_quantity else consignment_quantity end as consignment_quantity,
consignment_quantity_lost_during_dispatch,
consignment_packed_quantity,
destination_expected_quantity,
excess_received_quantity,
lost_in_transit_quantity,
received_quantity,
inbound_request_count,
inbound_request_id,
inbound_request_status,
inbound_request_updated_timestamp,
inbound_request_updated_date_key,
inbound_request_updated_time_key,
'' as inbound_request_updated_by,
case when outbound_request_status not in('completed','lost') then 'processing'
when outbound_request_status = 'completed' and inbound_request_status = 'created' then 'dispatched'
when inbound_request_status = 'completed' then 'completed'
else concat('Inbound_',inbound_request_status) end as iwit_current_status,
ta_pickup_date_key,
ta_pickup_time_key,
ta_expected_delivery_date_key,
ta_expected_delivery_time_key,
ta_created_date_key,
ta_created_time_key,
ta_updated_date_key,
ta_updated_time_key,
ta_requested_by,
ta_vendor_name,
ta_tracking_id,
ta_warehouse_id,
ob_product_key as product_key,
pl_request_id,
pl_internal_id,
pl_request_type,
pl_requestor_type,
pl_inventory_type,
pl_mode,
pl_request_created_at,
pl_request_created_date_key,
pl_request_created_time_key,
pl_request_updated_at,
pl_request_updated_date_key,
pl_request_updated_time_key,
pl_current_status,
pl_expected_dispatch_date,
pl_expected_dispatch_date_key,
pl_expected_dispatch_time_key,
pl_tracking_id,
pl_source_external_id,
pl_source_type,
pl_source_pincode,
pl_destination_external_id,
pl_destination_type,
pl_destination_pincode,
pl_consignment_group_id,
pl_creation_in_progress_at,
pl_creation_in_progress_date_key,
pl_creation_in_progress_time_key,
pl_status_new_at,
pl_status_new_date_key,
pl_status_new_time_key,
pl_status_open_at,
pl_status_open_date_key,
pl_status_open_time_key,
pl_status_approved_at,
pl_status_approved_date_key,
pl_status_approved_time_key,
pl_status_cancelled_at,
pl_status_cancelled_date_key,
pl_status_cancelled_time_key,
pl_status_closed_at,
pl_status_closed_date_key,
pl_status_closed_time_key,
pl_status_pending_at,
pl_status_pending_date_key,
pl_status_pending_time_key,
ship_group_id,
sg_internal_id,
sg_external_tracking_id,
ship_group_type,
ship_group_created_at,
ship_group_created_date_key,
ship_group_created_time_key,
ship_group_updated_at,
ship_group_updated_date_key,
ship_group_updated_time_key,
ship_group_current_status,
ship_group_isrejected,
sg_expected_delivery_date,
sg_expected_delivery_date_key,
sg_expected_delivery_time_key,
sg_expected_dispatch_date,
sg_expected_dispatch_date_key,
sg_expected_dispatch_time_key,
sg_actual_delivery_date,
sg_actual_delivery_date_key,
sg_actual_delivery_time_key,
sg_receiving_hub_name,
sg_receiving_hub_id,
sg_receiving_hub_type,
sg_lost_quantity,
sg_status_creation_in_progress_at,
sg_status_creation_in_progress_date_key,
sg_status_creation_in_progress_time_key,
sg_status_created_at,
sg_status_created_date_key,
sg_status_created_time_key,
sg_status_ready_for_pickup_at,
sg_status_ready_for_pickup_date_key,
sg_status_ready_for_pickup_time_key,
sg_status_warehouse_dispatched_at,
sg_status_warehouse_dispatched_date_key,
sg_status_warehouse_dispatched_time_key,
sg_status_dispatched_at,
sg_status_dispatched_date_key,
sg_status_dispatched_time_key,
sg_status_returned_at,
sg_status_returned_date_key,
sg_status_returned_time_key,
sg_status_received_at,
sg_status_received_date_key,
sg_status_received_time_key,
sg_status_rejected_at,
sg_status_rejected_date_key,
sg_status_rejected_time_key,
sg_status_completed_at,
sg_status_completed_date_key,
sg_status_completed_time_key,
sg_status_cancelled_at,
sg_status_cancelled_date_key,
sg_status_cancelled_time_key,
tat.threepl_tat as threepl_tat,
ic.str_id,
ic.str_created_date,
lookup_date(ic.str_created_date) as str_created_date_key, 
lookup_time(ic.str_created_date) as str_created_time_key,
ic.stn_id,
ic.stn_created_date,
lookup_date(ic.stn_created_date) as stn_created_date_key, 
lookup_time(ic.stn_created_date) as stn_created_time_key,
ic.srn_id,
ic.srn_created_date,
lookup_date(ic.srn_created_date) as srn_created_date_key, 
lookup_time(srn_created_date) as srn_createdtime_key,
ic.sro_id,
ic.sro_created_date,
lookup_date(ic.sro_created_date) as sro_created_date_key, 
lookup_time(ic.sro_created_date) as sro_created_time_key,
ic.fsn,
ic.source_warehouse,
ic.destination_warehouse,
ic.source_warehouse_area,
ic.destination_warehouse_area,
ic.requested_quantity,
ic.available_quantity,
ic.dispatched_quantity,
ic.lost_quantity,
ic.accepted_quantity,
ic.rejected_quantity,
ic.mrp
from
(select 
nco.outbound_request_consignment_id as consignment_id,
nco.outbound_request_company as consignment_company,
nco.outbound_request_id as outbound_request_id,
nco.outbound_request_status as outbound_request_status,
nco.outbound_request_external_id as outbound_request_external_id,
nco.consignment_status as consignment_status,
nco.consignment_packed_by as consignment_packed_by,
nco.ta_requested_by as ta_requested_by,
nco.ta_vendor_name as ta_vendor_name,
nco.ta_tracking_id as ta_tracking_id,
nco.ta_warehouse_id as ta_warehouse_id,
nco.outbound_request_item_product_key as ob_product_key,
pd.product_detail_fsn as ob_fsn,
nco.outbound_request_warehouse_dim_key as source_warehouse_dim_key,
nco.outbound_request_destination_warehouse_dim_key as destination_warehouse_dim_key,
outbound_request_warehouse_id,
outbound_request_destination_party_id,
sum(nco.outbound_request_item_quantity) as outbound_created_quantity,
min( nco.outbound_request_created_timestamp ) as outbound_request_created_timestamp,
min(outbound_request_created_date_key) as outbound_request_created_date_key,
min(outbound_request_created_time_key) as outbound_request_created_time_key,
max( nco.outbound_request_updated_timestamp ) as outbound_request_updated_timestamp,
max(outbound_request_updated_date_key) as outbound_request_updated_date_key,
max(outbound_request_updated_time_key) as outbound_request_updated_time_key,
min( nco.picklist_created_timestamp) as min_picklist_created_timestamp,
min(picklist_created_date_key) as min_picklist_created_date_key,
min(picklist_created_time_key) as min_picklist_created_time_key,
max( nco.picklist_created_timestamp ) as max_picklist_created_timestamp,
max(picklist_created_date_key) as max_picklist_created_date_key,
max(picklist_created_time_key) as max_picklist_created_time_key,
min( nco.consignment_created_timestamp ) as consignment_created_timestamp,
min(consignment_created_date_key) as consignment_created_date_key,
min(consignment_created_time_key) as consignment_created_time_key,
max( nco.consignment_updated_timestamp ) as consignment_updated_timestamp,
max(consignment_updated_date_key) as consignment_updated_date_key,
max(consignment_updated_time_key) as consignment_updated_time_key,
max( nco.consignment_cancelled_timestamp ) as consignment_cancelled_timestamp,
max(consignment_cancelled_date_key) as consignment_cancelled_date_key,
max(consignment_cancelled_time_key) as consignment_cancelled_time_key,
max( nco.consignment_dispatched_timestamp ) as consignment_dispatched_timestamp,
max(consignment_dispatched_date_key) as consignment_dispatched_date_key,
max(consignment_dispatched_time_key) as consignment_dispatched_time_key,
max( nco.consignment_packed_timestamp ) as consignment_packed_timestamp,
max(consignment_packed_date_key) as consignment_packed_date_key,
max(consignment_packed_time_key) as consignment_packed_time_key,
max(nco.ta_pickup_date_key) as ta_pickup_date_key,
max(nco.ta_pickup_time_key) as ta_pickup_time_key,
max(nco.ta_expected_delivery_date_key) as ta_expected_delivery_date_key,
max(nco.ta_expected_delivery_time_key) as ta_expected_delivery_time_key,
max(nco.ta_created_date_key) as ta_created_date_key,
max(nco.ta_created_time_key) as ta_created_time_key,
max(nco.ta_updated_date_key) as ta_updated_date_key,
max(nco.ta_updated_time_key) as ta_updated_time_key,
max(nco.pl_request_id) as pl_request_id,
max(nco.pl_internal_id) as pl_internal_id,
max(nco.pl_request_type) as pl_request_type,
max(nco.pl_requestor_type) as pl_requestor_type,
max(nco.pl_inventory_type) as pl_inventory_type,
max(nco.pl_mode) as pl_mode,
max(nco.pl_request_created_at) as pl_request_created_at,
max(nco.pl_request_created_date_key) as pl_request_created_date_key,
max(nco.pl_request_created_time_key) as pl_request_created_time_key,
max(nco.pl_request_updated_at) as pl_request_updated_at,
max(nco.pl_request_updated_date_key) as pl_request_updated_date_key,
max(nco.pl_request_updated_time_key) as pl_request_updated_time_key,
max(nco.pl_current_status) as pl_current_status,
max(nco.pl_expected_dispatch_date) as pl_expected_dispatch_date,
max(nco.pl_expected_dispatch_date_key) as pl_expected_dispatch_date_key,
max(nco.pl_expected_dispatch_time_key) as pl_expected_dispatch_time_key,
max(nco.pl_tracking_id) as pl_tracking_id,
max(nco.pl_source_external_id) as pl_source_external_id,
max(nco.pl_source_type) as pl_source_type,
max(nco.pl_source_pincode) as pl_source_pincode,
max(nco.pl_destination_external_id) as pl_destination_external_id,
max(nco.pl_destination_type) as pl_destination_type,
max(nco.pl_destination_pincode) as pl_destination_pincode,
max(nco.pl_consignment_group_id) as pl_consignment_group_id,
max(nco.pl_creation_in_progress_at) as pl_creation_in_progress_at,
max(nco.pl_creation_in_progress_date_key) as pl_creation_in_progress_date_key,
max(nco.pl_creation_in_progress_time_key) as pl_creation_in_progress_time_key,
max(nco.pl_status_new_at) as pl_status_new_at,
max(nco.pl_status_new_date_key) as pl_status_new_date_key,
max(nco.pl_status_new_time_key) as pl_status_new_time_key,
max(nco.pl_status_open_at) as pl_status_open_at,
max(nco.pl_status_open_date_key) as pl_status_open_date_key,
max(nco.pl_status_open_time_key) as pl_status_open_time_key,
max(nco.pl_status_approved_at) as pl_status_approved_at,
max(nco.pl_status_approved_date_key) as pl_status_approved_date_key,
max(nco.pl_status_approved_time_key) as pl_status_approved_time_key,
max(nco.pl_status_cancelled_at) as pl_status_cancelled_at,
max(nco.pl_status_cancelled_date_key) as pl_status_cancelled_date_key,
max(nco.pl_status_cancelled_time_key) as pl_status_cancelled_time_key,
max(nco.pl_status_closed_at) as pl_status_closed_at,
max(nco.pl_status_closed_date_key) as pl_status_closed_date_key,
max(nco.pl_status_closed_time_key) as pl_status_closed_time_key,
max(nco.pl_status_pending_at) as pl_status_pending_at,
max(nco.pl_status_pending_date_key) as pl_status_pending_date_key,
max(nco.pl_status_pending_time_key) as pl_status_pending_time_key,
max(nco.ship_group_id) as ship_group_id,
max(nco.sg_internal_id) as sg_internal_id,
max(nco.sg_external_tracking_id) as sg_external_tracking_id,
max(nco.ship_group_type) as ship_group_type,
max(nco.ship_group_created_at) as ship_group_created_at,
max(nco.ship_group_created_date_key) as ship_group_created_date_key,
max(nco.ship_group_created_time_key) as ship_group_created_time_key,
max(nco.ship_group_updated_at) as ship_group_updated_at,
max(nco.ship_group_updated_date_key) as ship_group_updated_date_key,
max(nco.ship_group_updated_time_key) as ship_group_updated_time_key,
max(nco.ship_group_current_status) as ship_group_current_status,
max(nco.ship_group_isrejected) as ship_group_isrejected,
max(nco.sg_expected_delivery_date) as sg_expected_delivery_date,
max(nco.sg_expected_delivery_date_key) as sg_expected_delivery_date_key,
max(nco.sg_expected_delivery_time_key) as sg_expected_delivery_time_key,
max(nco.sg_expected_dispatch_date) as sg_expected_dispatch_date,
max(nco.sg_expected_dispatch_date_key) as sg_expected_dispatch_date_key,
max(nco.sg_expected_dispatch_time_key) as sg_expected_dispatch_time_key,
max(nco.sg_actual_delivery_date) as sg_actual_delivery_date,
max(nco.sg_actual_delivery_date_key) as sg_actual_delivery_date_key,
max(nco.sg_actual_delivery_time_key) as sg_actual_delivery_time_key,
max(nco.sg_receiving_hub_name) as sg_receiving_hub_name,
max(nco.sg_receiving_hub_id) as sg_receiving_hub_id,
max(nco.sg_receiving_hub_type) as sg_receiving_hub_type,
max(nco.sg_lost_quantity) as sg_lost_quantity,
max(nco.sg_status_creation_in_progress_at) as sg_status_creation_in_progress_at,
max(nco.sg_status_creation_in_progress_date_key) as sg_status_creation_in_progress_date_key,
max(nco.sg_status_creation_in_progress_time_key) as sg_status_creation_in_progress_time_key,
max(nco.sg_status_created_at) as sg_status_created_at,
max(nco.sg_status_created_date_key) as sg_status_created_date_key,
max(nco.sg_status_created_time_key) as sg_status_created_time_key,
max(nco.sg_status_ready_for_pickup_at) as sg_status_ready_for_pickup_at,
max(nco.sg_status_ready_for_pickup_date_key) as sg_status_ready_for_pickup_date_key,
max(nco.sg_status_ready_for_pickup_time_key) as sg_status_ready_for_pickup_time_key,
max(nco.sg_status_warehouse_dispatched_at) as sg_status_warehouse_dispatched_at,
max(nco.sg_status_warehouse_dispatched_date_key) as sg_status_warehouse_dispatched_date_key,
max(nco.sg_status_warehouse_dispatched_time_key) as sg_status_warehouse_dispatched_time_key,
max(nco.sg_status_dispatched_at) as sg_status_dispatched_at,
max(nco.sg_status_dispatched_date_key) as sg_status_dispatched_date_key,
max(nco.sg_status_dispatched_time_key) as sg_status_dispatched_time_key,
max(nco.sg_status_returned_at) as sg_status_returned_at,
max(nco.sg_status_returned_date_key) as sg_status_returned_date_key,
max(nco.sg_status_returned_time_key) as sg_status_returned_time_key,
max(nco.sg_status_received_at) as sg_status_received_at,
max(nco.sg_status_received_date_key) as sg_status_received_date_key,
max(nco.sg_status_received_time_key) as sg_status_received_time_key,
max(nco.sg_status_rejected_at) as sg_status_rejected_at,
max(nco.sg_status_rejected_date_key) as sg_status_rejected_date_key,
max(nco.sg_status_rejected_time_key) as sg_status_rejected_time_key,
max(nco.sg_status_completed_at) as sg_status_completed_at,
max(nco.sg_status_completed_date_key) as sg_status_completed_date_key,
max(nco.sg_status_completed_time_key) as sg_status_completed_time_key,
max(nco.sg_status_cancelled_at) as sg_status_cancelled_at,
max(nco.sg_status_cancelled_date_key) as sg_status_cancelled_date_key,
max(nco.sg_status_cancelled_time_key) as sg_status_cancelled_time_key
from bigfoot_external_neo.scp_warehouse__fc_non_cust_outbound_l1_hive_fact nco
left join bigfoot_external_neo.scp_warehouse__fc_product_detail_hive_dim pd on pd.fc_product_detail_hive_dim_key = nco.outbound_request_item_product_key
where
nco.outbound_request_type = 'iwit'
and nco.outbound_request_status <> 'cancelled'
group by 
nco.outbound_request_consignment_id,
nco.outbound_request_id,
nco.outbound_request_status,
nco.outbound_request_external_id,
nco.consignment_status,
nco.consignment_packed_by,
nco.ta_requested_by,
nco.ta_vendor_name,
nco.ta_tracking_id,
nco.ta_warehouse_id,
nco.outbound_request_company,
nco.outbound_request_item_product_key,
pd.product_detail_fsn,
nco.outbound_request_destination_warehouse_dim_key,
outbound_request_warehouse_dim_key,
outbound_request_warehouse_id,
outbound_request_destination_party_id
) ob
left join 
(select co.consignment_id,co.consignment_company,co.product_key as product_key,
ir.inbound_request_id,ir.inbound_request_status,ir.destination_expected_quantity,ir.excess_received_quantity,
ir.lost_in_transit_quantity,ir.received_quantity,ir.inbound_request_updated_timestamp,ir.inbound_request_updated_date_key,
ir.inbound_request_updated_time_key,ir.inbound_request_count,co.consignment_quantity,co.consignment_quantity_lost_during_dispatch,
co.consignment_packed_quantity
from
(select
nco1.outbound_request_consignment_id as consignment_id,
nco1.outbound_request_company as consignment_company,
nco1.outbound_request_item_product_key as product_key,
sum( nco1.outbound_request_item_quantity ) as consignment_quantity,
--max( nco1.consignment_item_quantity_lost_during_dispatch ) as consignment_quantity_lost_during_dispatch,
sum(CASE WHEN nco1.consignment_item_polymorphic_type = 'wsn' THEN nco1.consignment_item_quantity_lost_during_dispatch ELSE 0 END) +
sum(DISTINCT CASE WHEN nco1.consignment_item_polymorphic_type = 'wid' THEN nco1.consignment_item_quantity_lost_during_dispatch ELSE 0 END) as consignment_quantity_lost_during_dispatch,
--max( case when nco1.consignment_item_quantity_packed ) as consignment_packed_quantity
sum(CASE WHEN nco1.consignment_item_polymorphic_type = 'wsn' THEN nco1.consignment_item_quantity_packed ELSE 0 END) +
sum(DISTINCT CASE WHEN nco1.consignment_item_polymorphic_type = 'wid' THEN nco1.consignment_item_quantity_packed ELSE 0 END) as consignment_packed_quantity
from
bigfoot_external_neo.scp_warehouse__fc_non_cust_outbound_l1_hive_fact nco1
where
nco1.outbound_request_type = 'iwit'
and nco1.outbound_request_status <> 'cancelled' and nco1.outbound_request_consignment_id is not null
group by
nco1.outbound_request_consignment_id,
nco1.outbound_request_company,
nco1.outbound_request_item_product_key
) co 
full outer join
(select
inbound_request_document_id as inbound_request_document_id,
warehouse_company as warehouse_company,
iri.inbound_request_status as inbound_request_status,
iri.product_key as product_key,
iri.inbound_request_entity_id as inbound_request_id,
sum( if( inbound_request_item_status <> 'excess', iri.inbound_request_item_quantity,0) ) as destination_expected_quantity,
sum( if( inbound_request_item_status = 'excess', iri.inbound_request_item_quantity,0) ) as excess_received_quantity,
sum( if( inbound_request_item_status = 'cancelled', iri.inbound_request_item_quantity,0) ) as lost_in_transit_quantity,
sum( if( inbound_request_item_status = 'completed', iri.inbound_request_item_quantity,0) ) as received_quantity,
max( iri.inbound_request_item_updated_at ) as inbound_request_updated_timestamp,
max(inbound_request_item_updated_date_key) as inbound_request_updated_date_key,
max(inbound_request_item_updated_time_key) as inbound_request_updated_time_key,
count( distinct iri.inbound_request_entity_id ) as inbound_request_count
from
bigfoot_external_neo.scp_warehouse__fc_inbound_request_item_l0_hive_fact iri
where
iri.inbound_request_type = 'iwit'
group by
iri.inbound_request_document_id,
iri.warehouse_company,
iri.product_key,
inbound_request_status,
iri.inbound_request_entity_id
) ir on
co.consignment_id = ir.inbound_request_document_id
and co.consignment_company = ir.warehouse_company
and co.product_key = ir.product_key) ci
on ci.consignment_id = ob.consignment_id
and ci.consignment_company = ob.consignment_company
and ci.product_key = ob.ob_product_key
left join bigfoot_common.fc_pnl_iwit_cost_mapping tat 
on ob.outbound_request_warehouse_id = tat.source 
and ob.outbound_request_destination_party_id = tat.destination
and tat.month = '201706'
left join bigfoot_external_neo.retail_procurement__iwit_core_fact ic
on ic.stn_id = ob.outbound_request_external_id
and ic.fsn = ob.ob_fsn
