INSERT OVERWRITE TABLE fc_outbound_breach_unit_l2_hive_fact
PARTITION (fulfill_item_unit_dispatch_by_date_key)
select 
breach_final.fulfill_item_unit_id,
breach_final.fulfill_item_unit_dispatch_by_cutoff,
breach_final.autoheal_flag,
breach_final.fulfill_item_unit_dispatch_by_time_key,
breach_final.seller_id_key,
breach_final.shipment_movement_type,
breach_final.promise_tier,
breach_final.breach_cost,
breach_final.fiu_warehouse_id,
breach_final.region_type,
breach_final.sales_channel,
breach_final.fulfill_reference_id,
breach_final.fiu_status,
breach_final.warehouse_order_item_id,
breach_final.unhold_date,
breach_final.unhold_time,
breach_final.order_item_un_hold_timestamp,
breach_final.is_on_hold,
breach_final.order_status,
breach_final.order_external_id,
breach_final.order_item_id,
breach_final.reservation_status,
breach_final.reservation_created_timestamp,
breach_final.reservation_created_datekey,
breach_final.reservation_created_timekey,
breach_final.reservation_quantity,
breach_final.reservation_cancelled_timestamp,
breach_final.picklist_id,
breach_final.picklist_created_timestamp,
breach_final.picklist_created_date_key,
breach_final.picklist_created_time_key,
breach_final.picklist_completed_by,
breach_final.picklist_completed_timestamp,
breach_final.picklist_completed_date_key,
breach_final.picklist_completed_time_key,
breach_final.pickzone,
breach_final.shipment_id,
breach_final.shipment_status,
breach_final.shipment_created_timestamp,
breach_final.dispatched_timestamp,
breach_final.dispatched_date_key,
breach_final.dispatched_time_key,
breach_final.fiu_dispatched_timestamp,
breach_final.warehouse_dim_key,
breach_final.warehouse_id,
breach_final.warehouse_company,
breach_final.product_key,
breach_final.test_wh_flag,
breach_final.is_pending,
breach_final.is_met,
breach_final.is_fc_hold,
breach_final.is_fc_pending,
breach_final.is_breach,
breach_final.is_fulfillment_breach,
if(breach_final.is_fulfillment_breach=0 and breach_final.is_cs_1_breach=1,1,0) as is_cs_breach,
if(breach_final.is_fulfillment_breach=0 and breach_final.is_cs_1_breach=0 and breach_final.is_breach=1,1,0) as is_fc_breach,
if(is_breach=1,if(breach_final.reservation_quantity>0,1,0),0) as is_breach_quantity,
breach_final.ibl_creation_timestamp,
breach_final.ibl_creation_date_key,
breach_final.ibl_creation_time_key,
breach_final.order_item_created_at,
breach_final.order_item_created_date_key,
breach_final.order_item_created_time_key,
breach_final.order_item_approved_timestamp,
breach_final.order_item_approved_date_key,
breach_final.order_item_approved_time_key,
breach_final.is_yesterday,
breach_final.shipment_merchant_reference_id,
0 as unproductive_time,
breach_final.order_item_is_freebie as order_item_is_freebie,
breach_final.shipment_item_quantity as shipment_item_quantity,
breach_final.dbd_from_reservation,
breach_final.dbd_from_reservation_date_key,
breach_final.dbd_from_reservation_time_key,
breach_final.is_breach_new,
breach_final.is_fulfillment_breach_new,
if(breach_final.is_fulfillment_breach_new=0 and breach_final.is_cs_1_breach_new=1,1,0) as is_cs_breach_new,
if(breach_final.is_fulfillment_breach_new=0 and breach_final.is_cs_1_breach_new=0 and breach_final.is_breach_new=1,1,0) as is_fc_breach_new,
if(is_breach_new=1,if(breach_final.reservation_quantity>0,1,0),0) as is_breach_quantity_new,
breach_final.reservation_inventory_item_id as reservation_inventory_item_id,
breach_final.reservation_id as reservation_id,
psn1.number1 as number1,
psn1.number2 as number2,
psn1.number3 as number3,
psn1.imei_mapping_present_flag as imei_mapping_present_flag,
breach_final.fulfill_item_unit_dispatch_by_date_key
from
(select breach_ft.fulfill_item_unit_id,
breach_ft.fulfill_item_unit_dispatch_by_cutoff,
breach_ft.autoheal_flag,
breach_ft.fulfill_item_unit_dispatch_by_date_key,
breach_ft.fulfill_item_unit_dispatch_by_time_key,
breach_ft.seller_id_key,
breach_ft.shipment_movement_type,
breach_ft.promise_tier,
breach_ft.breach_cost,
breach_ft.fiu_warehouse_id,
breach_ft.region_type,
breach_ft.sales_channel,
breach_ft.fulfill_reference_id,
breach_ft.fiu_status,
breach_ft.warehouse_order_item_id,
breach_ft.unhold_date,
breach_ft.unhold_time,
breach_ft.order_item_un_hold_timestamp,
breach_ft.is_on_hold,
breach_ft.order_status,
breach_ft.order_external_id,
breach_ft.order_item_id,
breach_ft.order_item_created_at,
breach_ft.order_item_created_date_key,
breach_ft.order_item_created_time_key,
breach_ft.order_item_approved_timestamp,
breach_ft.order_item_approved_date_key,
breach_ft.order_item_approved_time_key,
breach_ft.reservation_status,
breach_ft.reservation_created_timestamp,
breach_ft.reservation_created_datekey,
breach_ft.reservation_created_timekey,
breach_ft.reservation_quantity,
breach_ft.reservation_cancelled_timestamp,
breach_ft.dbd_from_reservation,
breach_ft.dbd_from_reservation_date_key,
breach_ft.dbd_from_reservation_time_key,
breach_ft.picklist_id,
breach_ft.picklist_created_timestamp,
breach_ft.picklist_created_date_key,
breach_ft.picklist_created_time_key,
breach_ft.picklist_completed_by,
breach_ft.picklist_completed_timestamp,
breach_ft.picklist_completed_date_key,
breach_ft.picklist_completed_time_key,
breach_ft.pickzone,
breach_ft.shipment_id,
breach_ft.shipment_status,
breach_ft.shipment_created_timestamp,
breach_ft.dispatched_timestamp,
breach_ft.fiu_dispatched_timestamp,
breach_ft.warehouse_dim_key,
breach_ft.warehouse_id,
breach_ft.warehouse_company,
breach_ft.product_key,
breach_ft.test_wh_flag,
breach_ft.is_pending,
breach_ft.is_fc_hold,
breach_ft.is_fc_pending,
breach_ft.is_breach,
breach_ft.dispatched_date_key,
breach_ft.dispatched_time_key,
breach_ft.ibl_creation_timestamp,
breach_ft.ibl_creation_date_key,
breach_ft.ibl_creation_time_key,
if(breach_ft.is_pending = 0 and breach_ft.dispatched_timestamp <= breach_ft.fulfill_item_unit_dispatch_by_cutoff,1,0) as is_met,
if(breach_ft.is_breach=1 and (unix_timestamp(breach_ft.fulfill_item_unit_dispatch_by_cutoff) - unix_timestamp(breach_ft.reservation_created_timestamp)) <9000,if(breach_ft.reservation_quantity>0,1,0),0) as is_fulfillment_breach,
--if(breach_ft.is_breach=1 and breach_ft.is_on_hold=1 and (breach_ft.reservation_status='hold' or breach_ft.order_status='on_hold' or (unix_timestamp(breach_ft.fulfill_item_unit_dispatch_by_cutoff) - unix_timestamp(breach_ft.order_item_un_hold_timestamp))<9000),if(breach_ft.reservation_quantity>0,1,0),0) as is_cs_1_breach,
--new cs breach logic
if(breach_ft.is_breach = 1 and breach_ft.is_on_hold=1 and breach_ft.reservation_quantity>0 
and (breach_ft.reservation_status='hold' or breach_ft.order_status='on_hold' or (unix_timestamp(breach_ft.fulfill_item_unit_dispatch_by_cutoff) - unix_timestamp(breach_ft.order_item_un_hold_timestamp))<9000),1,
if(breach_ft.is_breach = 1 and breach_ft.is_on_hold=0 and breach_ft.reservation_quantity>0
and (unix_timestamp(breach_ft.fulfill_item_unit_dispatch_by_cutoff) - unix_timestamp(breach_ft.order_item_un_hold_timestamp)) < 9000,1,0)) as is_cs_1_breach,
breach_ft.is_yesterday,
breach_ft.shipment_merchant_reference_id,
breach_ft.order_item_is_freebie as order_item_is_freebie,
breach_ft.shipment_item_quantity as shipment_item_quantity,
if(breach_ft.is_breach_new = 0 and breach_ft.dispatched_timestamp <= breach_ft.dbd_from_reservation,1,0) as is_met_new,
if(breach_ft.is_breach_new=1 and (unix_timestamp(breach_ft.dbd_from_reservation) - unix_timestamp(breach_ft.reservation_created_timestamp)) <9000,if(breach_ft.reservation_quantity>0,1,0),0) as is_fulfillment_breach_new,
if(breach_ft.is_breach_new=1 and breach_ft.is_on_hold=1 and (breach_ft.reservation_status='hold' or breach_ft.order_status='on_hold' or (unix_timestamp(breach_ft.dbd_from_reservation) - unix_timestamp(breach_ft.order_item_un_hold_timestamp))<9000),if(breach_ft.reservation_quantity>0,1,0),0) as is_cs_1_breach_new,
breach_ft.is_breach_new,
breach_ft.reservation_inventory_item_id as reservation_inventory_item_id,
breach_ft.reservation_id as reservation_id
from
(select fiu_temp.fulfill_item_unit_id, 
fiu_temp.fulfill_item_unit_dispatch_by_cutoff, 
fiu_temp.autoheal_flag,
fiu_temp.fulfill_item_unit_dispatch_by_date_key, 
fiu_temp.fulfill_item_unit_dispatch_by_time_key,
fiu_new.seller_id_key as seller_id_key,
fiu_new.fulfill_item_unit_shipment_movement_type as shipment_movement_type,
fiu_new.fulfill_item_unit_promise_tier as promise_tier,
fiu_new.fulfill_item_unit_breach_cost as breach_cost,
fiu_new.fulfill_item_unit_region as fiu_warehouse_id,
fiu_new.fulfill_item_unit_region_type as region_type,
fiu_new.fulfill_item_sales_channel as sales_channel,
fiu_new.fulfill_reference_id as fulfill_reference_id,
fiu_new.fulfill_item_unit_status_modified as fiu_status,
fiu_new.warehouse_order_item_id as warehouse_order_item_id,
if(fiu_temp.fulfill_item_unit_dispatch_by_cutoff >= concat(date_sub(FROM_UNIXTIME(UNIX_TIMESTAMP(),'yyyy-MM-dd') , 1),' 07:00:00')
and fiu_temp.fulfill_item_unit_dispatch_by_cutoff <= concat(to_date(from_unixtime(unix_timestamp())),' 07:00:00'),1,0) as is_yesterday,
fiu_new.shipment_merchant_reference_id, 
oms.order_item_un_hold_max_date_key as unhold_date,
oms.order_item_un_hold_max_time_key as unhold_time,
concat(substr(oms.order_item_un_hold_max_date_key,1,4),"-",substr(oms.order_item_un_hold_max_date_key,5,2),"-",substr(oms.order_item_un_hold_max_date_key,7,2)," ",(CASE WHEN oms.order_item_un_hold_max_time_key < 60 THEN concat("00",":",CAST(oms.order_item_un_hold_max_time_key AS STRING)) WHEN oms.order_item_un_hold_max_time_key < 960 THEN concat(SUBSTR(CAST(oms.order_item_un_hold_max_time_key AS STRING),1,1),':',SUBSTR(CAST(oms.order_item_un_hold_max_time_key AS STRING),2,2)) ELSE concat(SUBSTR(CAST(oms.order_item_un_hold_max_time_key AS STRING),1,2),':',SUBSTR(CAST(oms.order_item_un_hold_max_time_key AS STRING),3,2)) END)) as order_item_un_hold_timestamp,
oms.order_item_unit_is_on_hold as is_on_hold,
oms.order_status as order_status,
oms.order_external_id as order_external_id,
oms.order_item_id as order_item_id,
oms.order_item_created_at as order_item_created_at,
lookup_date(oms.order_item_created_at) as order_item_created_date_key,
lookup_time(oms.order_item_created_at) as order_item_created_time_key,
oms.order_item_approve_date_time as order_item_approved_timestamp,
lookup_date(oms.order_item_approve_date_time) as order_item_approved_date_key,
lookup_time(oms.order_item_approve_date_time) as order_item_approved_time_key,
res.reservation_status as reservation_status,
res.reservation_created_timestamp as reservation_created_timestamp,
res.reservation_created_date_key as reservation_created_datekey,
res.reservation_created_time_key as reservation_created_timekey,
res.reservation_quantity as reservation_quantity,
res.reservation_cancelled_timestamp as reservation_cancelled_timestamp,
res.picklist_display_id as picklist_id,
res.picklist_created_timestamp as picklist_created_timestamp,
res.picklist_created_date_key as picklist_created_date_key,
res.picklist_created_time_key as picklist_created_time_key,
res.picklist_compledted_by as picklist_completed_by,
res.picklist_item_picked_timestamp as picklist_completed_timestamp,
res.picklist_created_date_key as picklist_completed_date_key,
res.picklist_created_time_key as picklist_completed_time_key,
res.picklist_picking_zone as pickzone,
ship.shipment_display_id as shipment_id,
ship.shipment_status as shipment_status,
ship.shimpment_created_timestamp as shipment_created_timestamp,
if(ship.shipment_dispatched_timestamp is null,fiu_new.fulfill_item_unit_dispatch_actual_time,ship.shipment_dispatched_timestamp) as dispatched_timestamp,
ship.shipment_dispatched_date_key as dispatched_date_key,
ship.shipment_dispatched_time_key as dispatched_time_key,
ship.shipment_qc_done_timestamp as ibl_creation_timestamp,
ship.shipment_qc_done_date_key as ibl_creation_date_key,
ship.shipment_qc_done_time_key as ibl_creation_time_key,
fiu_new.fulfill_item_unit_dispatch_actual_time as fiu_dispatched_timestamp,
res.reservation_warehouse_id as warehouse_id,
res.warehouse_company as warehouse_company,
res.reservation_product_key as product_key,
res.reservation_ff_dispatch_by_date as dbd_from_reservation,
res.reservation_ff_dispatch_by_date_key as dbd_from_reservation_date_key,
res.reservation_ff_dispatch_by_time_key as dbd_from_reservation_time_key,
if(ship.shipment_warehouse_id like '%test%',1,0) as test_wh_flag,
if(if(ship.shipment_dispatched_timestamp is null,fiu_new.fulfill_item_unit_dispatch_actual_time,ship.shipment_dispatched_timestamp)is null and oms.order_status  not in('created','on_hold','cancelled'),if(res.reservation_quantity>0,1,0),0) 
as is_pending,
if(ship.shipment_status = 'on_hold',1,0) as is_fc_hold,
if(res.reservation_status='in_ship_group',1,0) as is_fc_pending,
if(if(ship.shipment_dispatched_timestamp is null,fiu_new.fulfill_item_unit_dispatch_actual_time,ship.shipment_dispatched_timestamp) is null or (if(ship.shipment_dispatched_timestamp is null,fiu_new.fulfill_item_unit_dispatch_actual_time,ship.shipment_dispatched_timestamp) > fiu_temp.fulfill_item_unit_dispatch_by_cutoff),1,0) 
as is_breach,
if(if(ship.shipment_dispatched_timestamp is null,fiu_new.fulfill_item_unit_dispatch_actual_time,ship.shipment_dispatched_timestamp) is null or (if(ship.shipment_dispatched_timestamp is null,fiu_new.fulfill_item_unit_dispatch_actual_time,ship.shipment_dispatched_timestamp) > res.reservation_ff_dispatch_by_date),1,0) 
as is_breach_new,
lookupkey('warehouse_id',res.reservation_warehouse_id) as warehouse_dim_key,
oms.order_item_is_freebie as order_item_is_freebie,
ship.shipment_item_quantity as shipment_item_quantity,
res1.reservation_inventory_item_id as reservation_inventory_item_id,
res.reservation_id as reservation_id
from
(select fiu.fulfill_item_unit_id as fulfill_item_unit_id,
fiu.fulfill_item_unit_dispatch_expected_time as fulfill_item_unit_dispatch_by_cutoff,
0 as autoheal_flag,
lookup_date(fiu.fulfill_item_unit_dispatch_expected_time) as fulfill_item_unit_dispatch_by_date_key,
lookup_time(fiu.fulfill_item_unit_dispatch_expected_time) as fulfill_item_unit_dispatch_by_time_key
from bigfoot_external_neo.scp_warehouse__fc_fulfillment_item_unit_mapping_hive_fact as fiu
where fiu.fulfill_item_unit_dispatch_expected_time is NOT NULL
union all
select fiu.fulfill_item_unit_id as fulfill_item_unit_id, 
fiu.fulfill_item_unit_dispatch_by_second_heal_datetime as fulfill_item_unit_dispatch_by_cutoff, 
2 as autoheal_flag,
lookup_date(fiu.fulfill_item_unit_dispatch_by_second_heal_datetime) as fulfill_item_unit_dispatch_by_date_key,
lookup_time(fiu.fulfill_item_unit_dispatch_by_second_heal_datetime) as fulfill_item_unit_dispatch_by_time_key
from 
bigfoot_external_neo.scp_warehouse__fc_fulfillment_item_unit_mapping_hive_fact as fiu
where fiu.fulfill_item_unit_dispatch_by_second_heal_datetime is NOT NULL
union all
select fiu.fulfill_item_unit_id as fulfill_item_unit_id, 
fiu.fulfill_item_unit_dispatch_by_first_heal_datetime as fulfill_item_unit_dispatch_by_cutoff, 
1 as autoheal_flag,
lookup_date(fiu.fulfill_item_unit_dispatch_by_first_heal_datetime) as fulfill_item_unit_dispatch_by_date_key,
lookup_time(fiu.fulfill_item_unit_dispatch_by_first_heal_datetime) as fulfill_item_unit_dispatch_by_time_key
from
bigfoot_external_neo.scp_warehouse__fc_fulfillment_item_unit_mapping_hive_fact as fiu
where fiu.fulfill_item_unit_dispatch_by_first_heal_datetime is NOT NULL) fiu_temp
left join
bigfoot_external_neo.scp_warehouse__fc_fulfillment_item_unit_mapping_hive_fact as fiu_new
on fiu_temp.fulfill_item_unit_id = fiu_new.fulfill_item_unit_id
left join
(select distinct order_item_id,order_item_unit_shipment_id,order_item_un_hold_max_date_key,order_item_un_hold_max_time_key,order_item_unit_is_on_hold,order_status,order_item_approve_date_time,order_external_id,order_item_created_at,order_item_is_freebie from bigfoot_external_neo.scp_oms__order_item_unit_s1_fact) oms
on fiu_new.customer_order_item_id = oms.order_item_id and oms.order_item_unit_shipment_id <=> fiu_new.shipment_merchant_reference_id
left join bigfoot_external_neo.scp_warehouse__fc_reservation_l0_hive_fact as res
on ( fiu_new.fulfill_reference_id = res.reservation_fulfill_reference_id and res.reservation_inv_source_type  <> 'non_fki' and 
res.reservation_outbound_type = 'customer_reservation')
left join bigfoot_external_neo.scp_warehouse__fc_reservation_l0_hive_fact as res1
on ( fiu_new.fulfill_reference_id = res1.reservation_fulfill_reference_id and 
res1.reservation_inv_source_type in ('non_fki','fbf') and 
res1.reservation_outbound_type = 'customer_reservation')
left join bigfoot_external_neo.scp_warehouse__fc_shipment_item_l0_hive_fact as ship
on (fiu_new.customer_order_item_id=ship.shipment_item_order_item_id and ship.shipment_display_id <=> fiu_new.shipment_merchant_reference_id )
where ship.shipment_destination_type is null or (ship.shipment_item_is_excess=0 and ship.shipment_item_status<>'cancelled' and ship.shipment_destination_type='customer'
and nvl(res.reservation_status,0)<>'cancelled'
)) breach_ft
where breach_ft.test_wh_flag = 0) breach_final
left join 
(
select 
psn.inventory_item_id,
concat_ws(',',collect_set(psn.number1)) as number1,
concat_ws(',',collect_set(psn.number2)) as number2,
concat_ws(',',collect_set(psn.number3)) as number3,
1 as imei_mapping_present_flag
from bigfoot_external_neo.scp_warehouse__fc_product_serial_number_map_l0_hive_fact psn
group by psn.inventory_item_id
) psn1 on (breach_final.reservation_inventory_item_id=psn1.inventory_item_id);